using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using Gmou.BusinessAccessLayer;
using Gmou.DomainModelEntities;
using Gmou.Web.Models;

namespace Gmou.Web.Controllers
{
    public class WayBillController : Controller
    {
        //
        // GET: /WayBill/

        public ActionResult Index()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            int? data = WayBillBAL.GetPendingVivraniSerial(user.LoginEmpID, user.DepartmentID);
            if (data != null)
            {
                ViewBag.vivraniID = data;
            }
            return PartialView(@"~/Views\WayBill\_wayBill.cshtml");
        }
        public ActionResult AddVivrani()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            Vivirani model = new Vivirani { UserID = user.LoginEmpID, DepartmentId = user.DepartmentID, IsSubmitted = false };
            var data = WayBillBAL.GetCashVivraiSerial(model);
            VivraniViewModel vivraniviewmodel = new VivraniViewModel
            {
                busowner = new SelectList(data.BusOwner, "BusOwnerID", "BusOwnerName"),
                bus = new SelectList(data.bus, "BusID", "BusNumber"),
                fuelpump = new SelectList(data.fuelpump, "FuelPumpID", "PumpName"),
                fueltype = new SelectList(data.fueltype, "FuelTypeID", "FuelTypeName"),
                VivraniSerialNumber = data.VivraniSerialNumber
            };
            ViewBag.serialnumber = data.VivraniSerialNumber;
            return PartialView(@"~/Views\Admin\Partial\_vivraniEnrty.cshtml", vivraniviewmodel);

        }
        [HttpGet]
      public ActionResult GetBusOwnerName(string busID)
        {
            var data = WayBillBAL.GetOwnerDetails(busID);
            return Json(data, JsonRequestBehavior.AllowGet);
        }
        [HttpGet]
        public ActionResult ValidateWayBillSerialNumber(string waybillserialno, string waybillbookno, string busID)
        {
            var data = WayBillBAL.GetLastWayBill(Convert.ToInt32(waybillserialno), Convert.ToInt32(waybillbookno), Convert.ToInt32(busID));
         return Json(data, JsonRequestBehavior.AllowGet);
        }
        [HttpPost]
        public ActionResult AddVivraniDeatil(VivraniDetails model)
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            model.EmployeeID = user.LoginEmpID;
            model.DepartmentID = user.DepartmentID;
            var data = BusinessAccessLayer.WayBillBAL.AddVivraniDetails(model);
            return Json(data, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddOtherExpences()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            Vivirani model = new Vivirani { UserID = user.LoginEmpID, DepartmentId = user.DepartmentID, IsSubmitted = false };
            var data = WayBillBAL.GetCashSheetSerialNumber(model);
            VivraniViewModel vivraniviewmodel = new VivraniViewModel
            {

                bus = new SelectList(data.bus, "BusID", "BusNumber"),
                VivraniSerialNumber = data.CashSheetSerialNumber
            };
            ViewBag.Cashserialnumber = data.CashSheetSerialNumber;
            return PartialView(@"~/Views\Admin\Partial\_otherExpences.cshtml", vivraniviewmodel);

        }

        public ActionResult AddExpDetail(CashSheetDetails model)
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;

            model.DepartmentID = user.DepartmentID;
            model.InsertedBy = user.LoginEmpID;
            var data = WayBillBAL.AddCashsheetOtherExpenses(model);
            return Json(data, JsonRequestBehavior.AllowGet);
        }
        public ActionResult chkOutCashDetail()
        {

            return PartialView(@"~/Views\Admin\Partial\_cashCheckoutDetail.cshtml");
        }
        [HttpPost]
        public ActionResult GetCashSheet()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;

            var data = WayBillBAL.GetGeneratedCashSheet(user.LoginEmpID, user.DepartmentID);
            var cashSheetId = data.otherexepnseslist.Select(k => k.CashSheetSerial).FirstOrDefault();
            ViewBag.CashSheetID = cashSheetId;
            return Json(data, JsonRequestBehavior.AllowGet);
        }
        public ActionResult BusHistory()
        {
            var result = WayBillBAL.GetAllBusses();
            BusOwnerViewModel bo = new BusOwnerViewModel();

            bo.busownername = new SelectList(result.lstbusName, "BusID", "BusNumber");


            return PartialView(@"~/Views\WayBill\_bushistory.cshtml", bo);
         
        }
        [HttpGet]
        public ActionResult GetBusJourneyHistory(string busId)
        {
            int busID = Convert.ToInt32(busId);
            var result = WayBillBAL.GetBusHistory(busID);
            return Json(result, JsonRequestBehavior.AllowGet);
        }
        public ActionResult  Coupon(CouponDetails model)
        {
            return PartialView(@"~/Views\WayBill\_addCuppon.cshtml");
        }

        [HttpPost]
        public ActionResult SaveCouponDetails(CouponDetails model)
        {
            var data = WayBillBAL.BALSaveCouponDetails(model);
            return Json(data, JsonRequestBehavior.AllowGet);
        }
        [HttpGet]
        public ActionResult GetAllCouponDetails()
        {

            var data = WayBillBAL.BALGetAllCouponDetails();
            return Json(data, JsonRequestBehavior.AllowGet);
        }
        [HttpPost]
        public ActionResult SaveWayBillCouponDetails(CouponDetails model)
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            model.InsertedBy = user.LoginEmpID;
            var data = WayBillBAL.BALSaveWayBillCouponDetails(model);
            return Json(data, JsonRequestBehavior.AllowGet);
        }
      [HttpGet]
        public ActionResult GetAllWayBillCouponDetails(int waybillbookno, int waybillserialno)
        {
            var data = WayBillBAL.BALGetAllWayBillCouponDetails(waybillbookno, waybillserialno);
            return Json(data, JsonRequestBehavior.AllowGet);
        }
      public ActionResult AddWaybill()
      {
          var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
          Vivirani model = new Vivirani { UserID = user.LoginEmpID, DepartmentId = user.DepartmentID, IsSubmitted = false };
          var data = WayBillBAL.GetCashVivraiSerial(model);
          VivraniViewModel vivraniviewmodel = new VivraniViewModel
          {
              busowner = new SelectList(data.BusOwner, "BusOwnerID", "BusOwnerName"),
              bus = new SelectList(data.bus, "BusID", "BusNumber"),
              fuelpump = new SelectList(data.fuelpump, "FuelPumpID", "PumpName"),
              fueltype = new SelectList(data.fueltype, "FuelTypeID", "FuelTypeName"),
              VivraniSerialNumber = data.VivraniSerialNumber
          };
          ViewBag.serialnumber = data.VivraniSerialNumber;
          return PartialView(@"~/Views\\WayBill\_AddWaybill.cshtml", vivraniviewmodel);

      }
        [HttpPost]
        public ActionResult SaveWayBillEntry(WayBillModel model)
      {
          var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
          model.InsertedBy = user.LoginEmpID;
         var data= WayBillBAL.BALSaveWayBillEntry(model);
         return Json(data, JsonRequestBehavior.AllowGet);
      }
    }
}


