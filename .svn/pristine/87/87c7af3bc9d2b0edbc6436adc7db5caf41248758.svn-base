using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using Gmou.BusinessAccessLayer;
using Gmou.DomainModelEntities;
using Gmou.Web.Models;

namespace Gmou.Web.Controllers
{
    public class WayBillController : Controller
    {
        //
        // GET: /WayBill/

        public ActionResult Index()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            int? data = WayBillBAL.GetPendingVivraniSerial(user.LoginEmpID, user.DepartmentID);
            if (data != null)
            {
                ViewBag.vivraniID = data;
            }
            return PartialView(@"~/Views\WayBill\_wayBill.cshtml");
        }
        public ActionResult AddVivrani()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            Vivirani model = new Vivirani { UserID = user.LoginEmpID, DepartmentId = user.DepartmentID, IsSubmitted = false };
            var data = WayBillBAL.GetCashVivraiSerial(model);
            VivraniViewModel vivraniviewmodel = new VivraniViewModel
            {
                busowner = new SelectList(data.BusOwner, "BusOwnerID", "BusOwnerName"),
                bus = new SelectList(data.bus, "BusID", "BusNumber"),
                fuelpump = new SelectList(data.fuelpump, "FuelPumpID", "PumpName"),
                fueltype = new SelectList(data.fueltype, "FuelTypeID", "FuelTypeName"),
                VivraniSerialNumber = data.VivraniSerialNumber
            };
            ViewBag.serialnumber = data.VivraniSerialNumber;
            return PartialView(@"~/Views\Admin\Partial\_vivraniEnrty.cshtml", vivraniviewmodel);

        }
        // [HttpPost]
        //public ActionResult AddExpDetail(VivraniDetails model)
        //{
        //    var data = BusinessAccessLayer.WayBillBAL.AddVivraniDetails(model);
        //    return Json(data, JsonRequestBehavior.AllowGet);
        //}

        [HttpPost]
        public ActionResult AddVivraniDeatil(VivraniDetails model)
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            model.EmployeeID = user.LoginEmpID;
            model.DepartmentID = user.DepartmentID;
            var data = BusinessAccessLayer.WayBillBAL.AddVivraniDetails(model);
            return Json(data, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddOtherExpences()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;
            Vivirani model = new Vivirani { UserID = user.LoginEmpID, DepartmentId = user.DepartmentID, IsSubmitted = false };
            var data = WayBillBAL.GetCashSheetSerialNumber(model);
            VivraniViewModel vivraniviewmodel = new VivraniViewModel
            {

                bus = new SelectList(data.bus, "BusID", "BusNumber"),
                VivraniSerialNumber = data.CashSheetSerialNumber
            };
            ViewBag.Cashserialnumber = data.CashSheetSerialNumber;
            return PartialView(@"~/Views\Admin\Partial\_otherExpences.cshtml", vivraniviewmodel);

        }

        public ActionResult AddExpDetail(CashSheetDetails model)
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;

            model.DepartmentID = user.DepartmentID;
            model.InsertedBy = user.LoginEmpID;
            var data = WayBillBAL.AddCashsheetOtherExpenses(model);
            return Json(data, JsonRequestBehavior.AllowGet);
        }
        public ActionResult chkOutCashDetail()
        {

            return PartialView(@"~/Views\Admin\Partial\_cashCheckoutDetail.cshtml");
        }
        public ActionResult GetCashSheet()
        {
            var user = ((UserValidation.CustomPrincipal)(HttpContext.Request.RequestContext.HttpContext.User)).User;

            var data = WayBillBAL.GetGeneratedCashSheet(user.LoginEmpID, user.DepartmentID);
            var cashSheetId = data.otherexepnseslist.Select(k => k.CashSheetSerial).FirstOrDefault();
            ViewBag.CashSheetID = cashSheetId;
            return Json(data, JsonRequestBehavior.AllowGet);
        }
    }
}
